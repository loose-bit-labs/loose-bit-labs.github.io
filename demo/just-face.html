<!DOCTYPE html PUBLIC"-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<HTML xmlns="http://www.w3.org/1999/xhtml">
	<HEAD>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<meta content="utf-8" http-equiv="encoding">

		<TITLE>face-the-camera</TITLE>
		<!-- 
			This is low rent way to do a vTuber avatar.
			It's currently super primitive...
		-->

		<script type="module">
			const taskURL  = 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm';
			const modelURL = 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task';
			import vision from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";
			const { FaceLandmarker, FilesetResolver, DrawingUtils } = vision;
			const filesetResolver = await FilesetResolver.forVisionTasks( taskURL );
			const faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
				baseOptions: { modelAssetPath: modelURL, delegate: 'GPU' },
				outputFaceBlendshapes: true,
				runningMode: 'VIDEO',
				numFaces: 1
			});

			const canvas = document.getElementsByTagName( 'canvas' )[0];
			const video  = document.getElementsByTagName( 'video' )[0];
			const pre  = document.getElementsByTagName( 'pre' )[0];
			const list = document.getElementsByTagName( 'ul' )[0];
			video.style.display = 'none';

			const numeric_debugger = !true; // to show the numeric vertex ids

			const context = canvas.getContext( '2d' );
  			const drawingUtils = new DrawingUtils( context );
			const values = new Map();

			let lastVideoTime = -1;
			let results = undefined;
			let safePlease = false;

			const SIDES = 'Left Right'.split( ' ' );
			const TRIANGLES = [ [0, 11, 37], [0, 11, 267], [0, 37, 164], [0, 164, 267], [1, 4, 44], [1, 4, 274], [1, 19, 44], [1, 19, 274], [2, 94, 141], [2, 94, 370], [2, 97, 141], [2, 97, 167], [2, 164, 167], [2, 164, 393], [2, 326, 370], [2, 326, 393], [3, 51, 195], [3, 51, 236], [3, 195, 197], [3, 196, 197], [3, 196, 236], [4, 5, 51], [4, 5, 281], [4, 44, 45], [4, 45, 51], [4, 274, 275], [4, 275, 281], [5, 51, 195], [5, 195, 281], [6, 122, 168], [6, 122, 196], [6, 168, 351], [6, 196, 197], [6, 197, 419], [6, 351, 419], [7, 25, 33], [7, 25, 110], [7, 110, 163], [8, 9, 55], [8, 9, 285], [8, 55, 193], [8, 168, 193], [8, 168, 417], [8, 285, 417], [9, 55, 107], [9, 107, 108], [9, 108, 151], [9, 151, 337], [9, 285, 336], [9, 336, 337], [10, 109, 151], [10, 151, 338], [11, 12, 72], [11, 12, 302], [11, 37, 72], [11, 267, 302], [12, 13, 38], [12, 13, 268], [12, 38, 72], [12, 268, 302], [13, 38, 82], [13, 268, 312], [14, 15, 86], [14, 15, 316], [14, 86, 87], [14, 316, 317], [15, 16, 85], [15, 16, 315], [15, 85, 86], [15, 315, 316], [16, 17, 85], [16, 17, 315], [17, 18, 83], [17, 18, 313], [17, 83, 84], [17, 84, 85], [17, 313, 314], [17, 314, 315], [18, 83, 201], [18, 200, 201], [18, 200, 421], [18, 313, 421], [19, 44, 125], [19, 94, 141], [19, 94, 370], [19, 125, 141], [19, 274, 354], [19, 354, 370], [20, 60, 99], [20, 60, 166], [20, 79, 166], [20, 79, 238], [20, 99, 242], [20, 238, 242], [21, 54, 68], [21, 68, 71], [21, 71, 162], [22, 23, 145], [22, 23, 230], [22, 26, 154], [22, 26, 231], [22, 145, 153], [22, 153, 154], [22, 230, 231], [23, 24, 144], [23, 24, 229], [23, 144, 145], [23, 229, 230], [24, 110, 144], [24, 110, 228], [24, 228, 229], [25, 31, 226], [25, 31, 228], [25, 33, 130], [25, 110, 228], [25, 130, 226], [26, 112, 155], [26, 112, 232], [26, 154, 155], [26, 231, 232], [27, 28, 159], [27, 28, 222], [27, 29, 160], [27, 29, 223], [27, 159, 160], [27, 222, 223], [28, 56, 157], [28, 56, 221], [28, 157, 158], [28, 158, 159], [28, 221, 222], [29, 30, 160], [29, 30, 224], [29, 223, 224], [30, 160, 161], [30, 161, 247], [30, 224, 225], [30, 225, 247], [31, 111, 117], [31, 111, 226], [31, 117, 228], [32, 140, 171], [32, 140, 211], [32, 171, 208], [32, 194, 201], [32, 194, 211], [32, 201, 208], [33, 130, 247], [33, 246, 247], [34, 127, 139], [34, 127, 234], [34, 139, 156], [34, 143, 156], [34, 143, 227], [34, 227, 234], [35, 111, 143], [35, 111, 226], [35, 113, 124], [35, 113, 226], [35, 124, 143], [36, 100, 101], [36, 100, 142], [36, 101, 205], [36, 142, 203], [36, 203, 206], [36, 205, 206], [37, 39, 72], [37, 39, 167], [37, 164, 167], [38, 41, 72], [38, 41, 81], [38, 81, 82], [39, 40, 73], [39, 40, 92], [39, 72, 73], [39, 92, 165], [39, 165, 167], [40, 73, 74], [40, 74, 185], [40, 92, 186], [40, 185, 186], [41, 42, 74], [41, 42, 81], [41, 72, 73], [41, 73, 74], [42, 74, 184], [42, 80, 81], [42, 80, 183], [42, 183, 184], [43, 57, 61], [43, 57, 202], [43, 61, 146], [43, 91, 106], [43, 91, 146], [43, 106, 204], [43, 202, 204], [44, 45, 220], [44, 125, 237], [44, 220, 237], [45, 51, 134], [45, 134, 220], [46, 53, 63], [46, 53, 225], [46, 63, 70], [46, 70, 156], [46, 113, 124], [46, 113, 225], [46, 124, 156], [47, 100, 121], [47, 100, 126], [47, 114, 128], [47, 114, 217], [47, 121, 128], [47, 126, 217], [48, 49, 64], [48, 49, 131], [48, 64, 235], [48, 115, 131], [48, 115, 219], [48, 219, 235], [49, 64, 102], [49, 64, 129], [49, 102, 129], [49, 129, 209], [49, 131, 209], [50, 101, 118], [50, 101, 205], [50, 117, 118], [50, 117, 123], [50, 123, 187], [50, 187, 205], [51, 134, 236], [52, 53, 63], [52, 53, 223], [52, 63, 105], [52, 65, 66], [52, 65, 222], [52, 66, 105], [52, 222, 223], [53, 223, 224], [53, 224, 225], [54, 68, 104], [54, 103, 104], [55, 65, 107], [55, 65, 221], [55, 189, 193], [55, 189, 221], [56, 157, 173], [56, 173, 190], [56, 190, 221], [57, 61, 185], [57, 185, 186], [57, 186, 212], [57, 202, 212], [58, 132, 177], [58, 172, 215], [58, 177, 215], [59, 75, 166], [59, 75, 235], [59, 166, 219], [59, 219, 235], [60, 75, 166], [60, 75, 240], [60, 99, 240], [61, 76, 146], [61, 76, 184], [61, 184, 185], [62, 76, 77], [62, 76, 183], [62, 77, 96], [62, 78, 96], [62, 78, 191], [62, 183, 191], [63, 68, 71], [63, 68, 104], [63, 70, 71], [63, 104, 105], [64, 98, 129], [64, 98, 240], [64, 102, 129], [64, 235, 240], [65, 66, 107], [65, 221, 222], [66, 69, 105], [66, 69, 107], [67, 69, 104], [67, 69, 108], [67, 103, 104], [67, 108, 109], [69, 104, 105], [69, 107, 108], [70, 71, 139], [70, 139, 156], [71, 139, 162], [74, 184, 185], [75, 235, 240], [76, 77, 146], [76, 183, 184], [77, 90, 91], [77, 90, 96], [77, 91, 146], [78, 95, 96], [79, 166, 218], [79, 218, 237], [79, 237, 239], [79, 238, 239], [80, 183, 191], [83, 84, 181], [83, 181, 182], [83, 182, 201], [84, 85, 180], [84, 180, 181], [85, 86, 179], [85, 179, 180], [86, 87, 178], [86, 178, 179], [88, 89, 96], [88, 89, 179], [88, 95, 96], [88, 178, 179], [89, 90, 96], [89, 90, 180], [89, 179, 180], [90, 91, 181], [90, 180, 181], [91, 106, 182], [91, 181, 182], [92, 165, 206], [92, 186, 216], [92, 206, 216], [93, 132, 137], [93, 137, 227], [93, 227, 234], [97, 98, 99], [97, 98, 165], [97, 99, 242], [97, 141, 242], [97, 165, 167], [98, 99, 240], [98, 129, 203], [98, 165, 203], [100, 101, 120], [100, 120, 121], [100, 126, 142], [101, 118, 119], [101, 119, 120], [106, 182, 194], [106, 194, 204], [108, 109, 151], [110, 144, 163], [111, 116, 123], [111, 116, 143], [111, 117, 123], [112, 133, 155], [112, 133, 243], [112, 232, 233], [112, 233, 244], [112, 243, 244], [113, 225, 247], [113, 226, 247], [114, 128, 188], [114, 174, 188], [114, 174, 217], [115, 131, 220], [115, 218, 219], [115, 218, 220], [116, 123, 137], [116, 137, 227], [116, 143, 227], [117, 118, 229], [117, 228, 229], [118, 119, 230], [118, 229, 230], [119, 120, 230], [120, 121, 232], [120, 230, 231], [120, 231, 232], [121, 128, 232], [122, 168, 193], [122, 188, 196], [122, 188, 245], [122, 193, 245], [123, 137, 177], [123, 147, 177], [123, 147, 187], [124, 143, 156], [125, 141, 241], [125, 237, 241], [126, 129, 142], [126, 129, 209], [126, 209, 217], [127, 139, 162], [128, 188, 245], [128, 232, 233], [128, 233, 245], [129, 142, 203], [130, 226, 247], [131, 134, 198], [131, 134, 220], [131, 198, 209], [132, 137, 177], [133, 173, 190], [133, 190, 243], [134, 198, 236], [135, 136, 138], [135, 136, 150], [135, 138, 192], [135, 150, 169], [135, 169, 214], [135, 192, 214], [136, 138, 172], [138, 172, 215], [138, 192, 213], [138, 213, 215], [140, 148, 171], [140, 148, 176], [140, 170, 176], [140, 170, 211], [141, 241, 242], [147, 177, 215], [147, 187, 213], [147, 213, 215], [148, 152, 175], [148, 171, 175], [149, 150, 170], [149, 170, 176], [150, 169, 170], [151, 337, 338], [152, 175, 377], [161, 246, 247], [164, 267, 393], [165, 203, 206], [166, 218, 219], [168, 351, 417], [169, 170, 211], [169, 210, 211], [169, 210, 214], [171, 175, 199], [171, 199, 208], [174, 188, 196], [174, 196, 236], [174, 217, 236], [175, 199, 396], [175, 377, 396], [182, 194, 201], [186, 212, 216], [187, 192, 213], [187, 192, 214], [187, 205, 207], [187, 207, 214], [189, 190, 221], [189, 190, 243], [189, 193, 244], [189, 243, 244], [193, 244, 245], [194, 204, 211], [195, 197, 248], [195, 248, 281], [197, 248, 419], [198, 209, 217], [198, 217, 236], [199, 200, 208], [199, 200, 428], [199, 396, 428], [200, 201, 208], [200, 421, 428], [202, 204, 210], [202, 210, 214], [202, 212, 214], [204, 210, 211], [205, 206, 216], [205, 207, 216], [207, 212, 214], [207, 212, 216], [218, 220, 237], [233, 244, 245], [237, 239, 241], [238, 239, 241], [238, 241, 242], [248, 281, 456], [248, 419, 456], [249, 255, 263], [249, 255, 339], [249, 339, 390], [250, 290, 328], [250, 290, 392], [250, 309, 392], [250, 309, 459], [250, 328, 462], [250, 458, 459], [250, 458, 462], [251, 284, 298], [251, 298, 301], [251, 301, 389], [252, 253, 374], [252, 253, 450], [252, 256, 381], [252, 256, 451], [252, 374, 380], [252, 380, 381], [252, 450, 451], [253, 254, 373], [253, 254, 449], [253, 373, 374], [253, 449, 450], [254, 339, 373], [254, 339, 448], [254, 448, 449], [255, 261, 446], [255, 261, 448], [255, 263, 359], [255, 339, 448], [255, 359, 446], [256, 341, 382], [256, 341, 452], [256, 381, 382], [256, 451, 452], [257, 258, 386], [257, 258, 442], [257, 259, 387], [257, 259, 443], [257, 386, 387], [257, 442, 443], [258, 286, 384], [258, 286, 441], [258, 384, 385], [258, 385, 386], [258, 441, 442], [259, 260, 387], [259, 260, 444], [259, 443, 444], [260, 387, 388], [260, 388, 466], [260, 444, 445], [260, 445, 467], [260, 466, 467], [261, 340, 346], [261, 340, 446], [261, 346, 448], [262, 369, 396], [262, 369, 431], [262, 396, 428], [262, 418, 421], [262, 418, 431], [262, 421, 428], [263, 359, 467], [263, 466, 467], [264, 356, 368], [264, 356, 454], [264, 368, 383], [264, 372, 383], [264, 372, 447], [264, 447, 454], [265, 340, 372], [265, 340, 446], [265, 342, 353], [265, 342, 446], [265, 353, 372], [266, 329, 330], [266, 329, 371], [266, 330, 425], [266, 371, 423], [266, 423, 426], [266, 425, 426], [267, 269, 302], [267, 269, 393], [268, 271, 302], [268, 271, 311], [268, 311, 312], [269, 270, 303], [269, 270, 322], [269, 302, 303], [269, 322, 391], [269, 391, 393], [270, 303, 304], [270, 304, 409], [270, 322, 410], [270, 409, 410], [271, 272, 304], [271, 272, 311], [271, 302, 303], [271, 303, 304], [272, 304, 408], [272, 310, 311], [272, 310, 407], [272, 407, 408], [273, 287, 291], [273, 287, 422], [273, 291, 375], [273, 321, 335], [273, 321, 375], [273, 335, 424], [273, 422, 424], [274, 275, 440], [274, 354, 457], [274, 440, 457], [275, 281, 363], [275, 363, 440], [276, 283, 293], [276, 283, 445], [276, 293, 300], [276, 300, 383], [276, 342, 353], [276, 342, 445], [276, 353, 383], [277, 329, 350], [277, 329, 355], [277, 343, 357], [277, 343, 437], [277, 350, 357], [277, 355, 437], [278, 279, 294], [278, 279, 360], [278, 294, 455], [278, 344, 360], [278, 344, 439], [278, 439, 455], [279, 294, 331], [279, 294, 358], [279, 331, 358], [279, 358, 429], [279, 360, 429], [280, 330, 347], [280, 330, 425], [280, 346, 347], [280, 346, 352], [280, 352, 411], [280, 411, 425], [281, 363, 456], [282, 283, 293], [282, 283, 443], [282, 293, 334], [282, 295, 296], [282, 295, 442], [282, 296, 334], [282, 442, 443], [283, 443, 444], [283, 444, 445], [284, 298, 333], [284, 332, 333], [285, 295, 336], [285, 295, 441], [285, 413, 417], [285, 413, 441], [286, 384, 398], [286, 398, 414], [286, 414, 441], [287, 291, 409], [287, 409, 410], [287, 410, 432], [287, 422, 432], [288, 361, 401], [288, 397, 435], [288, 401, 435], [289, 290, 305], [289, 290, 392], [289, 305, 455], [289, 392, 439], [289, 439, 455], [290, 305, 460], [290, 328, 460], [291, 306, 375], [291, 306, 408], [291, 408, 409], [292, 306, 307], [292, 306, 407], [292, 307, 325], [292, 308, 325], [292, 308, 415], [292, 407, 415], [293, 298, 301], [293, 298, 333], [293, 300, 301], [293, 333, 334], [294, 327, 358], [294, 327, 460], [294, 331, 358], [294, 455, 460], [295, 296, 336], [295, 441, 442], [296, 299, 334], [296, 299, 336], [297, 299, 333], [297, 299, 337], [297, 332, 333], [297, 337, 338], [299, 333, 334], [299, 336, 337], [300, 301, 368], [300, 368, 383], [301, 368, 389], [304, 408, 409], [305, 455, 460], [306, 307, 375], [306, 407, 408], [307, 320, 321], [307, 320, 325], [307, 321, 375], [308, 324, 325], [309, 392, 438], [309, 438, 457], [309, 457, 459], [310, 407, 415], [313, 314, 405], [313, 405, 406], [313, 406, 421], [314, 315, 404], [314, 404, 405], [315, 316, 403], [315, 403, 404], [316, 317, 402], [316, 402, 403], [318, 319, 325], [318, 319, 403], [318, 324, 325], [318, 402, 403], [319, 320, 325], [319, 320, 404], [319, 403, 404], [320, 321, 405], [320, 404, 405], [321, 335, 406], [321, 405, 406], [322, 391, 426], [322, 410, 436], [322, 426, 436], [323, 361, 366], [323, 366, 447], [323, 447, 454], [326, 327, 328], [326, 327, 391], [326, 328, 462], [326, 370, 462], [326, 391, 393], [327, 328, 460], [327, 358, 423], [327, 391, 423], [329, 330, 349], [329, 349, 350], [329, 355, 371], [330, 347, 348], [330, 348, 349], [335, 406, 418], [335, 418, 424], [339, 373, 390], [340, 345, 352], [340, 345, 372], [340, 346, 352], [341, 362, 382], [341, 362, 463], [341, 452, 453], [341, 453, 464], [341, 463, 464], [342, 445, 467], [342, 446, 467], [343, 357, 412], [343, 399, 412], [343, 399, 437], [344, 360, 440], [344, 438, 439], [344, 438, 440], [345, 352, 366], [345, 366, 447], [345, 372, 447], [346, 347, 449], [346, 448, 449], [347, 348, 450], [347, 449, 450], [348, 349, 450], [349, 350, 452], [349, 450, 451], [349, 451, 452], [350, 357, 452], [351, 412, 419], [351, 412, 465], [351, 417, 465], [352, 366, 401], [352, 376, 401], [352, 376, 411], [353, 372, 383], [354, 370, 461], [354, 457, 461], [355, 358, 371], [355, 358, 429], [355, 429, 437], [356, 368, 389], [357, 412, 465], [357, 452, 453], [357, 453, 465], [358, 371, 423], [359, 446, 467], [360, 363, 420], [360, 363, 440], [360, 420, 429], [361, 366, 401], [362, 398, 414], [362, 414, 463], [363, 420, 456], [364, 365, 367], [364, 365, 379], [364, 367, 416], [364, 379, 394], [364, 394, 434], [364, 416, 434], [365, 367, 397], [367, 397, 435], [367, 416, 433], [367, 433, 435], [369, 377, 396], [369, 377, 400], [369, 395, 400], [369, 395, 431], [370, 461, 462], [376, 401, 435], [376, 411, 433], [376, 433, 435], [378, 379, 395], [378, 395, 400], [379, 394, 395], [391, 423, 426], [392, 438, 439], [394, 395, 431], [394, 430, 431], [394, 430, 434], [399, 412, 419], [399, 419, 456], [399, 437, 456], [406, 418, 421], [410, 432, 436], [411, 416, 433], [411, 416, 434], [411, 425, 427], [411, 427, 434], [413, 414, 441], [413, 414, 463], [413, 417, 464], [413, 463, 464], [417, 464, 465], [418, 424, 431], [420, 429, 437], [420, 437, 456], [422, 424, 430], [422, 430, 434], [422, 432, 434], [424, 430, 431], [425, 426, 436], [425, 427, 436], [427, 432, 434], [427, 432, 436], [438, 440, 457], [453, 464, 465], [457, 459, 461], [458, 459, 461], [458, 461, 462], ];

			// this is not right somehow....
			const FACEMESH_LEFT_EYEBROW = [276, 283, 282, 295, 285, 300, 293, 334, 296, 336,   276];
			const FACEMESH_RIGHT_EYEBROW = [46, 53, 52, 65, 55, 70, 63, 105, 66, 107,    46];

			// junky data just for centroids...
			const FACEMESH_LEFT_EYE = [249, 263, 362, 373, 374, 380, 381, 382, 384, 385, 386, 387, 388, 390, 398, 466];
			const FACEMESH_RIGHT_EYE = [7, 33, 133, 144, 145, 153, 154, 155, 157, 158, 159, 160, 161, 163, 173, 246];
			const FACE_MESH_LIPS = [0, 13, 14, 17, 37, 39, 40, 61, 78, 80, 81, 82, 84, 87, 88, 91, 95, 146, 178, 181, 185, 191, 267, 269, 270, 291, 308, 310, 311, 312, 314, 317, 318, 321, 324, 375, 402, 405, 409, 415];

			const pickIt = (choices,key) => {
				const s = values.get( key ).scaled;
				const i = Math.floor( choices.length * s );
				const j = isNaN( i ) ? 0 : i;
				const c = choices[ j < 0 ? 0 : j > choices-1 ? choices-1 : j ];
				return c ? c : '-';
			};

			const gimme = ( base, ...options ) => {
				const r = SIDES.map(
					(k,i) => pickIt( options[ i%options.length], `${base}${k}` )
				);
				if ( r.length != 2 ) console.log( base, r );
				return r;
			};

			const newValue = () => {return {values:[],current:0,scaled:0,min:Infinity,max:-Infinity};};
				
			const saveShapes = ( list, blendShapes ) => {
				blendShapes[0].categories.forEach((shape) => {
					const name = shape.displayName || shape.categoryName;
					if ( !values.has( name ) ) {
						values.set( name, newValue() );
						//list.appendChild( list[ name ] = document.createElement( 'li' ) );
					}

					const data = values.get( name ) ;
					data.current = shape.score;
					data.min = Math.min(data.min, data.current);
					data.max = Math.max(data.max, data.current);
					data.scaled = (data.current - data.min) / (data.max - data.min);

					data.score = shape.score;
					//list[ name ].innerHTML = `${name}: ${data.scaled.toFixed( 2 )}`;
				});
			};

			const showYouYou = () => {
				const smileV = SIDES.map( s => values.get( `mouthSmile${s}` ).scaled  ).reduce( (s,v) => s + v * .5, 0 );
				const jawV = values.get( 'jawOpen' ).scaled - smileV * .5;
				const eyes = gimme( 'eyeWide', '>-oooooooooo0000000OOOOOOOOO','<-oooooooooo0000000OOOOOOOOO' ).join('.');
				const smile = gimme( 'mouthSmile', '-`', "-'" ).join('-');
				const pucker = values.get( 'mouthPucker' ).scaled > .33 ? ' = ' : null
				const jaw = jawV > .66 ? ' O ' : jawV > .44 ? ' o ' : null;
				const mouth = pucker || jaw || smile;

				//pre.innerHTML = `this is you:\n${eyes}\n${mouth}\n`;
				pre.innerHTML = '';

				context.fillStyle = 'white';
				context.fillStyle = '#FD7';
				context.fillText( eyes, 33, canvas.height - 66 );
				context.fillText( mouth, 33, canvas.height - 33 );
			}

			const drawBlendShapes = ( list, blendShapes ) => {
				if (!blendShapes.length) return;
				saveShapes( list, blendShapes );
				showYouYou();
			};

			const download = ( filename, data, type = 'application/json;charset=utf-8', expiration = 3 * 1000 ) => {
				data = [data];

				const blob = new Blob( data, {type} );
				const url = window.URL.createObjectURL( blob );

				const a = document.createElement( 'a' );
				a.style.display = 'none';
				a.href = url;
				a.download = filename;
				document.body.appendChild( a );

				a.click();
				setTimeout(() => { document.body.removeChild( a ); window.URL.revokeObjectURL( url ); }, expiration );
			};

			const dd = (landmarks, landmark, c) =>  drawingUtils.drawConnectors( landmarks, landmark, c );
			const predictWebcam = () => {
				let nowInMs = Date.now();
				if (lastVideoTime !== video.currentTime) {
					lastVideoTime = video.currentTime;
					results = faceLandmarker.detectForVideo( video, nowInMs );
				}

				if (numeric_debugger) { 
					canvas.width  = 3 * video.videoWidth;
					canvas.height = 3 * video.videoHeight;
				} else {
					if ( canvas.width != video.videoWidth )   canvas.width  = video.videoWidth;
					if ( canvas.height != video.videoHeight ) canvas.height = video.videoHeight;
				}

				if (results.faceLandmarks && results.faceLandmarks.length) {
	                context.clearRect(0, 0, canvas.width, canvas.height);
					prettyPoly(results);
					//showYouYou();
				}
				window.requestAnimationFrame(predictWebcam);
			}

			const toRBG = (c) => {
				return 'rgb(' + c.join(',') + ')';
			}

			const prettyPoly = (results) => {
				const landmarks = results.faceLandmarks[0];
				//const color = [252, 101, 121];
				const color = [112, 141, 231].map(c=>c*1.4);
				//const color = [212, 141, 131].map(c=>c*1.4);
				context.strokeStyle = toRBG(color.map(c=>c*.6));
				context.lineWidth = 2;
                    
				const screenNormal = { x: 0, y: 0, z: -1 };

				const f = 1.2, g = -.1;
				landmarks.forEach(landmark => {
					const x = 1.1;//1.8 - landmark.y * .9; // weird mapping fun
					landmark.sx = f * landmark.x * canvas.width  * x  + g * canvas.width ;
					//landmark.sx -= x * canvas.width * .3; // weird mapping fun
					landmark.sy = f * landmark.y * canvas.height  + g * canvas.height;
					if (numeric_debugger) landmark.sy -=200;
				});

				[FACEMESH_LEFT_EYE, FACEMESH_RIGHT_EYE].forEach(indices => {
					const centroid = computeCentroid(indices, landmarks);
					context.fillStyle = 'white';
					context.beginPath(); context.arc(centroid.sx, centroid.sy, 17, 0, Math.PI * 2); context.fill();
					context.fillStyle = '#D3D';
					context.beginPath(); context.arc(centroid.sx, centroid.sy, 7, 0, Math.PI * 2); context.fill();
					context.fillStyle = 'black';
					context.beginPath(); context.arc(centroid.sx, centroid.sy, 3, 0, Math.PI * 2); context.fill();
				});	

				drawMouthEllipse(context, landmarks, '#A12', 'white');
				painter(TRIANGLES, landmarks, color);


				const browColor = [141,88,111].map(c=>c * 1.1);
				[FACEMESH_LEFT_EYEBROW, FACEMESH_RIGHT_EYEBROW].forEach(poly => {
					const ptz = poly.map(i => landmarks[i]);
					drawPoly(ptz, browColor);
				});

				if (numeric_debugger) {
					context.font = '24px fixed';
					context.fillStyle = 'white';
					landmarks.forEach((p,i) => context.fillText(i, p.sx, p.sy));
			 	}	
			};
		
			const painter = (indices, landmarks, color) => {
				indices
					.slice() // copy so we don't mutate original
					.sort((a, b) => {
						// Compute average z for each triangle
						//const az = landmarks[a[0]].z;
						//const bz = landmarks[b[0]].z;
						const az = (landmarks[a[0]].z + landmarks[a[1]].z + landmarks[a[2]].z) / 3;
						const bz = (landmarks[b[0]].z + landmarks[b[1]].z + landmarks[b[2]].z) / 3;
						return bz - az; // draw smallest z first (back)
					})
					.forEach(poly => {
						const ptz = poly.map(i => landmarks[i]);
						drawPoly(ptz, color);
					});
			}

			const computeCentroid =( indices, landmarks) => {
				let sumX = 0;
				let sumY = 0;
				const n = indices.length;

				indices.forEach(i => {
					sumX += landmarks[i].sx;
					sumY += landmarks[i].sy;
				});

				return { sx: sumX / n, sy: sumY / n };
			}

			const drawMouthEllipse = (ctx, landmarks, mouthColor = '#212', teethColor = 'white') => {
				// Outer mouth corners
				const top = landmarks[13];
				const bottom = landmarks[14];
				const left = landmarks[78];
				const right = landmarks[308];

				// Compute center
				const cx = (left.sx + right.sx) / 2;
				const cy = (top.sy + bottom.sy) / 2;

				// Width and height
				const rx = Math.abs((right.sx - left.sx) / 2);   // horizontal radius
				const ry = Math.abs((bottom.sy - top.sy) / 2);   // vertical radius

				// Compute rotation angle from left → right
				const angle = Math.atan2(right.sy - left.sy, right.sx - left.sx);

				// Draw mouth ellipse
				ctx.fillStyle = mouthColor;
				ctx.beginPath();
				ctx.ellipse(cx, cy, rx, ry, angle, 0, Math.PI * 2);
				ctx.fill();

				// Draw upper teeth
				const f = 1.8; // fudge factor for vertical offset
				const teethWidth = rx * 1.8;
				const teethHeight = ry * 0.4;
				
				ctx.fillStyle = teethColor;
				ctx.beginPath();
				ctx.ellipse(cx, cy - ry * f * 0.5, teethWidth / 2, teethHeight / 2, angle, 0, Math.PI * 2);
				ctx.fill();

				// Draw lower teeth
				ctx.beginPath();
				ctx.ellipse(cx, cy + ry * f * 0.5, teethWidth / 2, teethHeight / 2, angle, 0, Math.PI * 2);
				ctx.fill();
			};


			const drawPoly = (ptz, color) => {
				const screenNormal = { x: 0, y: 0, z: -1 };

				// Extract vertices from landmark indices
				const [v1, v2, v3] = ptz;

				// Compute edge vectors (v1→v2, v1→v3)
				const U = { x: v2.x - v1.x, y: v2.y - v1.y, z: v2.z - v1.z };
				const V = { x: v3.x - v1.x, y: v3.y - v1.y, z: v3.z - v1.z };

				// Cross product U × V
				const normal = normalize({
					x: U.y * V.z - U.z * V.y,
					y: U.z * V.x - U.x * V.z,
					z: U.x * V.y - U.y * V.x
				});

				// Compare with screen normal
				const dot = (
					normal.x * screenNormal.x +
					normal.y * screenNormal.y +
					normal.z * screenNormal.z
				);
				color = color.map(c => c * Math.abs(dot) + 11);
				context.fillStyle = 'rgb(' + color.join(',') + ')';

				context.beginPath();
				ptz.forEach((pt,i)=> i ? context.lineTo(pt.sx, pt.sy) : context.moveTo(pt.sx, pt.sy));
				context.closePath();

				context.stroke();
				context.fill();
			};

			const normalize = (pt) => {
				const length = Math.hypot(pt.x, pt.y, pt.z);
				return Object.fromEntries(
					Object.entries(pt).map(([k, v]) => [k, v / length])
				);
			}

			const move = 'mousemove';
			const start = () => {
				canvas.removeEventListener( move, start );
  				const constraints = { video: true };

				navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
					video.srcObject = stream;
					video.addEventListener('loadeddata', predictWebcam);
				});
			};

			const demo = () => {
				context.fillStyle = 'green';
				context.font = '32px fixed';
				context.fillText( 'mouse over this canvas', 33, 33 );
				canvas.addEventListener( move, start );

				canvas.addEventListener( 'keydown', (event)=> {
					if ( 'enter' === event.key.toLowerCase() ) {
						safePlease = true;
					}
				});
			};

			demo();
		</script>

		<style>
			body { color:#ccb; background:green; font-family: sans-serif; margin:.5em; }
			video, canvas, pre { position:absolute; top:0px; left:0px; }
			video  { z-index:0; }
			canvas { z-index:1; }
			.mirror {
				transform: rotateY(180deg);
				-webkit-transform:rotateY(180deg); /* Safari and Chrome */
				-moz-transform:rotateY(180deg); /* Firefox */
			}
			ul     { float:right; }
			pre    { top:488px; display:block; }
			* {
				scrollbar-width: none; /* Firefox */
				-ms-overflow-style: none; /* Internet Explorer 10+ */
			}
			*::-webkit-scrollbar { display: none; }
		</style>
	</HEAD>
	<BODY>
		<video id="webcam" style="position: abso" autoplay playsinline></video>
		<canvas width="640" height="480" tabindex="1" class="mirror"></canvas>
		<ul></ul>
		<pre>did you mouse over that canvas yet?</pre>
	</BODY>
</HTML>
